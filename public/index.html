<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>飛騰家電 - 會員登入</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>會員登入</h2>
  <div class="container">
    <img src="logo1.png" alt="飛騰家電logo" class="logo">
    <h2>會員登入</h2>
    <form onsubmit="return redirectToHome()" class="login-form">
        <div class="form-group">
            <label for="phone">電話號碼：</label>
            <input type="text" id="phone" name="phone" required placeholder="電話號碼">
        </div>
        <div class="form-group">
            <label for="password">密碼：</label>
            <input type="password" id="password" name="password" required placeholder="請輸入...">
        </div>
        <button type="submit" class="submit-button"  id="loginButton" onclick="login()">確認</button>
    </form>        
  </div>
  <!-- 加載提示 -->
  <div id="loading" style="display: none;">正在處理請求...</div>

  <script>
    // 呼叫 HASHBYTES API 來取得密碼的HASH
    async function getHashedPassword(password) {
      try {
        const response = await fetch('api/proxy-hash', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Password: password })
        });

        const data = await response.json();
        if (data && data.HASHBYTES) {
          return data.HASHBYTES;
        }
         else {
          console.error('HASH處理失敗', data);
          return null;
        }
      } catch (error) {
        console.error('無法取得HASH密碼', error);
        return null;
      }
    }

    async function login() {
      event.preventDefault(); // 阻止表單送出導致重新整理
      const phone = document.getElementById("phone").value.trim();
      const password = document.getElementById("password").value.trim();  // 讀取密碼欄位

      // 輸入驗證：檢查帳號與密碼是否為空
      if (!phone || !password) {
        alert('帳號或密碼不能為空');
        return;
      }

      // 固定帳號與密碼
      const userID = "vastar";
      const fixedPassword = "vastar@2673";
      
      // 首先，呼叫 HASHBYTES API 來取得密碼的HASH值
      const hashPassword = await getHashedPassword(fixedPassword);  // 使用固定密碼

      if (hashPassword) {
        // 當拿到HASH值後，傳送登入請求
        const response = await fetch('/api/proxy-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            UserID: userID,
            Password: fixedPassword,
            Account_Name: phone || '',  //電話號碼
            HASHBYTES: hashPassword  // HashPassword
          })
        });

        const result = await response.json();
        if (response.ok) {
            alert('登入成功！');
            localStorage.setItem('userName', result.name || '');
            redirectToHome();
        } else {
            alert('登入失敗: ' + result.message);
        }
      } else {
            alert('無法取得密碼HASH，請稍後再試！');
      }
      return false;
    }
  </script>
  <script>
    function redirectToHome() {
        window.location.href = "home.html";
        return false; // 阻止表單重新整理
    }
  </script>
</body>
</html>
