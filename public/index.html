<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>會員登入</title>
</head>
<body>
  <h2>會員登入</h2>
  <input id="name" placeholder="Account_Name (可選)"><br>
  <input id="password" type="password" placeholder="Password"><br> <!-- 密碼欄位 -->
  <button id="loginButton" onclick="login()">登入</button>

  <!-- 加載提示 -->
  <div id="loading" style="display: none;">正在處理請求...</div>

  <script>
    // 呼叫 HASHBYTES API 來取得密碼的HASH
    async function getHashedPassword(password) {
      try {
        const response = await fetch('api/proxy-hash', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ Password: password })
        });

        const data = await response.json();
        if (data && data.HASHBYTES) {
          return data.HASHBYTES;
        }
         else {
          console.error('HASH處理失敗', data);
          return null;
        }
      } catch (error) {
        console.error('無法取得HASH密碼', error);
        return null;
      }
    }

    async function login() {
      const name = document.getElementById("name").value.trim();
      const password = document.getElementById("password").value.trim();  // 讀取密碼欄位

      // 輸入驗證：檢查帳號與密碼是否為空
      if (!name || !password) {
        alert('帳號或密碼不能為空');
        return;
      }

      // 固定帳號與密碼
      const userID = "vastar";  // 寫死的 UserID
      const fixedPassword = "vastar@2673";  // 寫死的 Password

      // 首先，呼叫 HASHBYTES API 來取得密碼的HASH值
      const hashPassword = await getHashedPassword(fixedPassword);  // 使用固定密碼

      if (hashPassword) {
        // 當拿到HASH值後，傳送登入請求
        const response = await fetch('/api/proxy-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            UserID: userID,  // 固定的 UserID
            Password: fixedPassword,  // 使用固定密碼
            Account_Name: name || '',  // 若無輸入名稱，則傳送空字串
            HashPassword: hashPassword  // 傳送從 HASHBYTES API 獲得的HASH密碼
          })
        });

        const result = await response.json();
        if (response.ok) {
          alert('登入成功！');
          // 可進行後續操作，例如重定向到首頁
        } else {
          alert('登入失敗: ' + result.message);
        }
      } else {
        alert('無法取得密碼HASH，請稍後再試！');
      }
    }
  </script>
</body>
</html>
